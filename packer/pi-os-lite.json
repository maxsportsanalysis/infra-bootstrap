{
  "builders": [
    {
      "type": "qemu",
      "iso_url": "https://downloads.raspberrypi.org/raspios_lite_armhf_latest",
      "iso_checksum_type": "sha256",
      "iso_checksum": "<SHA256-of-ISO>",
      "output_directory": "build/pi-image",
      "format": "raw",
      "accelerator": "kvm",
      "disk_size": 8192,
      "ssh_username": "{{user `ssh_user`}}",
      "ssh_password": "{{user `ssh_pass`}}",
      "ssh_wait_timeout": "10m",
      "headless": true
    }
  ],
  "variables": {
    "ssh_user": "pi",
    "ssh_pass": "raspberry"
  },
  "provisioners": [
    {
      "type": "file",
      "source": "files/ca/my-root-ca.crt",
      "destination": "/home/pi/ca/my-root-ca.crt"
    },
    {
      "type": "file",
      "source": "scripts/init_pi.sh",
      "destination": "/home/pi/pi-bootstrap/init_pi.sh"
    },
    {
      "type": "shell",
      "inline": [
        "chmod +x /home/pi/pi-bootstrap/init_pi.sh",
        "sudo cp /home/pi/pi-bootstrap/init_pi.sh /usr/local/bin/init_pi.sh",
        "sudo chmod +x /usr/local/bin/init_pi.sh",
        "sudo bash -c 'cat <<EOF > /etc/systemd/system/init_pi.service\n[Unit]\nDescription=Pi Ephemeral Bootstrap\nAfter=network.target\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/init_pi.sh\nRemainAfterExit=yes\n[Install]\nWantedBy=multi-user.target\nEOF'",
        "sudo systemctl enable init_pi.service"
      ]
    }
  ]
}