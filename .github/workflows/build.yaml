name: Build Raspberry Pi PXE Image

on:
  push:
    branches:
      - main
  #workflow_dispatch:

env:
  PACKER_VERSION: "1.14.2"

jobs:
  build-pxe-image:
    runs-on: ubuntu-24.04-arm
    env:
      PACKER_LOG: 1
      PACKER_LOG_PATH: packer.log

    steps:
      # 1. Checkout your infra repo
      - name: Checkout repo
        uses: actions/checkout@v5

      # 2. Install dependencies for Packer / qemu
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      # 3. Install Packer
      - name: Setup `packer`
        uses: hashicorp/setup-packer@v3
        with:
          version: ${{ env.PACKER_VERSION }}

      # 4. Build the PXE server image
      - name: Run `packer init`
        run: packer init .

      - name: Run `packer validate`
        run: packer validate -var-file=pi.pkrvars.hcl .

      - name: Run `packer build`
        run: packer build -var-file=pi.pkrvars.hcl .

      # 5. Archive the resulting image artifact
      - name: Upload built image
        uses: actions/upload-artifact@v4
        with:
          name: pi-pxe-image
          path: image/
