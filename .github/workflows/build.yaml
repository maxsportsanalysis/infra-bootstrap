name: Build Raspberry Pi PXE Image

on:
  push:
    branches:
      - main
  #workflow_dispatch:

env:
  PACKER_VERSION: "1.14.2"
  PACKER_LOG: 1
  PACKER_LOG_PATH: packer.log
  RPI_USERNAME: ${{ secrets.RPI_USERNAME }}
  RPI_PASSWORD: ${{ secrets.RPI_PASSWORD }}

jobs:
  build-pxe-image:
    runs-on: ubuntu-24.04-arm
    steps:
      # 1. Checkout your infra repo
      - name: Checkout repo
        uses: actions/checkout@v5
      
      - name: Clone arm-image plugin repo
        run: git clone https://github.com/solo-io/packer-plugin-arm-image

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.1'
          cache-dependency-path: packer-plugin-arm-image/go.sum

      # 2. Install dependencies for Packer / qemu
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Build packer arm-image plugin
        run: |
          cd packer-plugin-arm-image
          go mod download
          go build -o packer-plugin-arm-image
          mkdir -p ~/.packer.d/plugins/github.com/solo-io/arm-image
          mv packer-plugin-arm-image ~/.packer.d/plugins/github.com/solo-io/arm-image/packer-plugin-arm-image


      # 3. Install Packer
      - name: Setup `packer`
        uses: hashicorp/setup-packer@v3
        with:
          version: ${{ env.PACKER_VERSION }}

      # 4. Build the PXE server image
      - name: Run `packer init`
        run: sudo packer init .

      - name: Run `packer validate`
        run: sudo packer validate -var-file=pi.pkrvars.hcl .

      - name: Run `packer build`
        run: sudo packer build \
            -var "rpi_username=${RPI_USERNAME}" \
            -var "rpi_password=${RPI_PASSWORD}" \
            -var-file=pi.pkrvars.hcl .

      # 5. Archive the resulting image artifact
      - name: Upload built image
        uses: actions/upload-artifact@v4
        with:
          name: pi-pxe-image
          path: rpi-pxe.img
