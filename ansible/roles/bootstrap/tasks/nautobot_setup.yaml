---
- name: Create nautobot system user with /opt/nautobot as home
  ansible.builtin.user:
    name: nautobot
    system: yes
    shell: /bin/bash
    create_home: yes
    home: /opt/nautobot

- name: Ensure /opt/nautobot directory exists and owned by nautobot
  ansible.builtin.file:
    path: /opt/nautobot
    state: directory
    owner: nautobot
    group: nautobot
    mode: '0750'

- name: Create Python virtualenv at /opt/nautobot
  ansible.builtin.command: python3 -m venv /opt/nautobot
  become_user: nautobot
  args:
    creates: /opt/nautobot/bin/activate

- name: Add NAUTOBOT_ROOT to the nautobot user .bashrc file
  ansible.builtin.lineinfile:
    path: /home/nautobot/.bashrc
    line: 'export NAUTOBOT_ROOT=/opt/nautobot'
    create: yes
    state: present
    owner: nautobot
    group: nautobot
    mode: '0644'

- name: Upgrade pip and install wheel in virtualenv
  ansible.builtin.command: /opt/nautobot/bin/pip install --upgrade pip wheel
  become_user: nautobot

- name: Create Nautobot environment file
  ansible.builtin.copy:
    dest: /opt/nautobot/nautobot.env
    owner: nautobot
    group: nautobot
    mode: "0600"
    content: |
      NAUTOBOT_ROOT=/opt/nautobot
      NAUTOBOT_CONFIG=/opt/nautobot/.nautobot/nautobot_config.py
      NAUTOBOT_SECRET_KEY={{ nautobot_secret_key }}
      NAUTOBOT_DB_PASSWORD={{ nautobot_password }}
      NAUTOBOT_ALLOWED_HOSTS="*"

- name: Install Nautobot with HTTPS-enabled pyuwsgi
  ansible.builtin.command: /opt/nautobot/bin/pip install --no-binary=pyuwsgi nautobot
  become_user: nautobot

- name: Create systemd service for Nautobot
  ansible.builtin.copy:
    dest: /opt/nautobot/uwsgi.ini
    owner: nautobot
    group: nautobot
    mode: '0640'
    content: |
      [uwsgi]
      ; The IP address (typically localhost) and port that the WSGI process should listen on
      socket = 127.0.0.1:8001

      ; Fail to start if any parameter in the configuration file isn't explicitly understood by uWSGI
      strict = true

      ; Enable master process to gracefully re-spawn and pre-fork workers
      master = true

      ; Allow Python app-generated threads to run
      enable-threads = true

      ;Try to remove all of the generated file/sockets during shutdown
      vacuum = true

      ; Do not use multiple interpreters, allowing only Nautobot to run
      single-interpreter = true

      ; Shutdown when receiving SIGTERM (default is respawn)
      die-on-term = true

      ; Prevents uWSGI from starting if it is unable load Nautobot (usually due to errors)
      need-app = true

      ; By default, uWSGI has rather verbose logging that can be noisy
      disable-logging = true

      ; Assert that critical 4xx and 5xx errors are still logged
      log-4xx = true
      log-5xx = true

      ; Enable HTTP 1.1 keepalive support
      http-keepalive = 1

      ;
      ; Advanced settings (disabled by default)
      ; Customize these for your environment if and only if you need them.
      ; Ref: https://uwsgi-docs.readthedocs.io/en/latest/Options.html
      ;

      ; Number of uWSGI workers to spawn. This should typically be 2n+1, where n is the number of CPU cores present.
      ; processes = 5

      ; If using subdirectory hosting e.g. example.com/nautobot, you must uncomment this line. Otherwise you'll get double paths e.g. example.com/nautobot/nautobot/.
      ; Ref: https://uwsgi-docs.readthedocs.io/en/latest/Changelog-2.0.11.html#fixpathinfo-routing-action
      ; route-run = fixpathinfo:

      ; If hosted behind a load balancer uncomment these lines, the harakiri timeout should be greater than your load balancer timeout.
      ; Ref: https://uwsgi-docs.readthedocs.io/en/latest/HTTP.html?highlight=keepalive#http-keep-alive
      ; harakiri = 65
      ; add-header = Connection: Keep-Alive
      ; http-keepalive = 1

- name: Create systemd service for Nautobot
  ansible.builtin.copy:
    dest: /etc/systemd/system/nautobot.service
    content: |
      [Unit]
      Description=Nautobot WSGI Service
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target redis-server.service postgresql.service
      Wants=network-online.target

      [Service]
      Type=simple
      EnvironmentFile=/opt/nautobot/nautobot.env

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot.pid
      WorkingDirectory=/opt/nautobot
      ExecStart=/opt/nautobot/bin/nautobot-server start --pidfile /var/tmp/nautobot.pid --ini /opt/nautobot/uwsgi.ini
      ExecStop=/opt/nautobot/bin/nautobot-server start --stop /var/tmp/nautobot.pid
      ExecReload=/opt/nautobot/bin/nautobot-server start --reload /var/tmp/nautobot.pid
      Restart=on-failure
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Create systemd service for Nautobot Celery Worker
  ansible.builtin.copy:
    dest: /etc/systemd/system/nautobot-worker.service
    content: |
      [Unit]
      Description=Nautobot Celery Worker
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=exec
      EnvironmentFile=/opt/nautobot/nautobot.env

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot-worker.pid
      WorkingDirectory=/opt/nautobot

      ExecStart=/opt/nautobot/bin/nautobot-server celery worker --loglevel INFO --pidfile /var/tmp/nautobot-worker.pid

      Restart=always
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Create systemd service for Nautobot Celery Beat Scheduler
  ansible.builtin.copy:
    dest: /etc/systemd/system/nautobot-scheduler.service
    content: |
      [Unit]
      Description=Nautobot Celery Beat Scheduler
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=exec
      EnvironmentFile=/opt/nautobot/nautobot.env

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot-scheduler.pid
      WorkingDirectory=/opt/nautobot

      ExecStart=/opt/nautobot/bin/nautobot-server celery beat --loglevel INFO --pidfile /var/tmp/nautobot-scheduler.pid

      Restart=always
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Ensure Nautobot services are enabled but not running
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: true
    state: stopped
  loop:
    - nautobot
    - nautobot-worker
    - nautobot-scheduler

- name: Create simple NGINX config for HTTP only on port 80
  ansible.builtin.copy:
    dest: /etc/nginx/sites-available/nautobot.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;

          server_name _;

          location / {
              include uwsgi_params;
              uwsgi_pass 127.0.0.1:8001;
              uwsgi_param Host $host;
              uwsgi_param X-Real-IP $remote_addr;
              uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
              uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
          }

          location /static/ {
              alias /opt/nautobot/static/;
          }

          client_max_body_size 25m;
      }

- name: Remove default NGINX site if it exists
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Create symlink for Nautobot NGINX site config
  ansible.builtin.file:
    src: /etc/nginx/sites-available/nautobot.conf
    dest: /etc/nginx/sites-enabled/nautobot.conf
    state: link

- name: Add nginx user www-data to nautobot group
  ansible.builtin.user:
    name: www-data
    groups: nautobot
    append: yes

- name: Reload NGINX after site configuration changes
  ansible.builtin.service:
    name: nginx
    state: reloaded
