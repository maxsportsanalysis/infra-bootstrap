---
- name: Include Apt Dependencies Task
  import_tasks: apt_dependencies.yaml

- name: Install HashiCorp Vault (binary)
  ansible.builtin.get_url:
    url: https://releases.hashicorp.com/vault/1.15.5/vault_1.15.5_linux_arm64.zip
    dest: /tmp/vault.zip

- name: Unzip Vault
  ansible.builtin.unarchive:
    src: /tmp/vault.zip
    dest: /usr/local/bin
    remote_src: yes
    mode: '0755'

- name: Install aws_signing_helper (ARM64 / AArch64)
  ansible.builtin.get_url:
    url: https://rolesanywhere.amazonaws.com/releases/1.7.3/Aarch64/Linux/Amzn2023/aws_signing_helper
    dest: /usr/local/bin/aws_signing_helper
    mode: '0755'
    force: no

- name: Ensure /media/pki_rpi directory exists
  ansible.builtin.file:
    path: /media/pki_rpi
    state: directory
    mode: '0750'

- name: Create systemd service for mounting pki_rpi usb
  copy:
    dest: /etc/systemd/system/media-pki_rpi.mount
    content: |
      [Unit]
      Description=PKI USB Mount
      After=local-fs.target

      [Mount]
      What=/dev/disk/by-label/PKI_RPI
      Where=/media/pki_rpi
      Type=vfat
      Options=rw,noatime,uid=1000,gid=1000,umask=007

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd


- name: Create udev rule to auto-mount PKI USB when plugged in
  copy:
    dest: /etc/udev/rules.d/99-pki_usb.rules
    content: |
      ACTION=="add", SUBSYSTEM=="block", ENV{ID_FS_LABEL}=="PKI_RPI", TAG+="systemd", ENV{SYSTEMD_WANTS}="media-pki_rpi.mount"

- name: Reload udev rules so hot-plug works immediately
  command: udevadm control --reload
  notify: Trigger udev

- name: Ensure systemd services are enabled but not running
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: true
    state: stopped
  loop:
    - media-pki_rpi.mount

- name: Reload systemd daemon after unit changes
  ansible.builtin.systemd:
    daemon_reload: yes








#- name: Tang and Clevis Auto Unlock Setup USB
#  import_tasks: decrypt_usb.yaml

# - name: Postgres Installation
#   import_tasks: postgres_installation.yaml
# 
# - name: Include Nautobot Task
#   import_tasks: nautobot_setup.yaml
# 
# - name: Systemd Service Initialization
#   import_tasks: service_initialization.yaml

#- name: Include Step Ca
#  import_tasks: step_ca_setup.yaml