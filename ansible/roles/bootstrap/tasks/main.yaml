---
- name: Install base dependencies
  ansible.builtin.apt:
    update_cache: yes
    pkg:
      - cryptsetup
      - git
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - redis-server
      - postgresql-common
    state: present

- name: Enable PostgreSQL setup script repository installation
  ansible.builtin.command:
    cmd: /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
  args:
    creates: /etc/apt/sources.list.d/pgdg.list
  register: pgdg_repo
  changed_when: "'Adding the repository' in pgdg_repo.stdout or 'added' in pgdg_repo.stdout"

- name: Install PostgreSQL server and client
  ansible.builtin.apt:
    name:
      - "postgresql-{{ postgres_version }}"
      - "postgresql-client-{{ postgres_version }}"
    state: present
    update_cache: yes

- name: Ensure PostgreSQL is installed but not running
  ansible.builtin.service:
    name: postgresql
    state: stopped
    enabled: yes

- name: Create nautobot system user with /opt/nautobot as home
  ansible.builtin.user:
    name: nautobot
    system: yes
    shell: /bin/bash
    create_home: yes
    home: /opt/nautobot

- name: Ensure /opt/nautobot directory exists and owned by nautobot
  ansible.builtin.file:
    path: /opt/nautobot
    state: directory
    owner: nautobot
    group: nautobot
    mode: '0755'

- name: Create Python virtualenv at /opt/nautobot
  ansible.builtin.command: python3 -m venv /opt/nautobot
  become_user: nautobot
  args:
    creates: /opt/nautobot/bin/activate

- name: Add NAUTOBOT_ROOT to the nautobot user .bashrc file
  ansible.builtin.lineinfile:
    path: /home/nautobot/.bashrc
    line: 'export NAUTOBOT_ROOT=/opt/nautobot'
    create: yes
    state: present
    owner: nautobot
    group: nautobot
    mode: '0644'

- name: Upgrade pip and install wheel in virtualenv
  ansible.builtin.command: /opt/nautobot/bin/pip install --upgrade pip wheel
  become_user: nautobot

- name: Install Nautobot with HTTPS-enabled pyuwsgi
  ansible.builtin.command: /opt/nautobot/bin/pip install --no-binary=pyuwsgi nautobot
  become_user: nautobot

- name: Create systemd service for Nautobot
  copy:
    dest: /etc/systemd/system/nautobot.service
    content: |
      [Unit]
      Description=Nautobot WSGI Service
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target redis-server.service postgresql.service
      Wants=network-online.target

      [Service]
      Type=simple
      Environment="NAUTOBOT_ROOT=/opt/nautobot"

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot.pid
      WorkingDirectory=/opt/nautobot
      ExecStart=/opt/nautobot/bin/nautobot-server start --pidfile /var/tmp/nautobot.pid --ini /opt/nautobot/uwsgi.ini
      ExecStop=/opt/nautobot/bin/nautobot-server start --stop /var/tmp/nautobot.pid
      ExecReload=/opt/nautobot/bin/nautobot-server start --reload /var/tmp/nautobot.pid
      Restart=on-failure
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Create systemd service for Nautobot Celery Worker
  copy:
    dest: /etc/systemd/system/nautobot-worker.service
    content: |
      [Unit]
      Description=Nautobot Celery Worker
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=exec
      Environment="NAUTOBOT_ROOT=/opt/nautobot"

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot-worker.pid
      WorkingDirectory=/opt/nautobot

      ExecStart=/opt/nautobot/bin/nautobot-server celery worker --loglevel INFO --pidfile /var/tmp/nautobot-worker.pid

      Restart=always
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Create systemd service for Nautobot Celery Beat Scheduler
  copy:
    dest: /etc/systemd/system/nautobot-scheduler.service
    content: |
      [Unit]
      Description=Nautobot Celery Beat Scheduler
      Documentation=https://docs.nautobot.com/projects/core/en/stable/
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=exec
      Environment="NAUTOBOT_ROOT=/opt/nautobot"

      User=nautobot
      Group=nautobot
      PIDFile=/var/tmp/nautobot-scheduler.pid
      WorkingDirectory=/opt/nautobot

      ExecStart=/opt/nautobot/bin/nautobot-server celery beat --loglevel INFO --pidfile /var/tmp/nautobot-scheduler.pid

      Restart=always
      RestartSec=30
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Ensure Nautobot services are enabled but not running
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: true
    state: stopped
  loop:
    - nautobot
    - nautobot-worker
    - nautobot-scheduler

### Intermediate CA Setup

- name: Unlock and mount encrypted USB
  block:
    - name: Open LUKS device
      command: >
        cryptsetup luksOpen /dev/disk/by-uuid/0c0c73a8-79f9-4554-b241-27636c5d6a9d intermediate_ca
      become: true

    - name: Mount unlocked volume
      mount:
        path: /mnt/intermediate_ca
        src: /dev/mapper/intermediate_ca
        fstype: ext4
        state: mounted


### CA SERVER

#- name: Install prerequisites for Smallstep
#  ansible.builtin.apt:
#    update_cache: yes
#    name:
#      - curl
#      - vim
#      - gpg
#      - ca-certificates
#    state: present
#    install_recommends: no
#
#- name: Add Smallstep APT repo GPG key
#  ansible.builtin.get_url:
#    url: https://packages.smallstep.com/keys/apt/repo-signing-key.gpg
#    dest: /etc/apt/trusted.gpg.d/smallstep.asc
#    mode: '0644'
#
#- name: Add Smallstep APT repository
#  ansible.builtin.apt_repository:
#    repo: 'deb [signed-by=/etc/apt/trusted.gpg.d/smallstep.asc] https://packages.smallstep.com/stable/debian debs main'
#    state: present
#    filename: smallstep
#
#- name: Update apt cache after adding Smallstep repo
#  ansible.builtin.apt:
#    update_cache: yes
#
#- name: Install step-cli and step-ca
#  ansible.builtin.apt:
#    name:
#      - step-cli
#      - step-ca
#    state: present
#
#- name: Create step-ca system user with /etc/step-ca as home
#  ansible.builtin.user:
#    name: step
#    system: yes
#    create_home: yes
#    home: /etc/step-ca
#    shell: /bin/false
#    comment: "Smallstep Certificate Authority service user"
#
#- name: Ensure /etc/step-ca directory exists with proper ownership
#  ansible.builtin.file:
#    path: /etc/step-ca
#    state: directory
#    owner: step
#    group: step
#    mode: '0750'
#
#- name: Grant step-ca binary permission to bind to low ports (e.g., 443)
#  ansible.builtin.command: >
#    setcap CAP_NET_BIND_SERVICE=+eip $(which step-ca)
#  args:
#    creates: /usr/bin/step-ca
#  become: yes
#
#- name: Move initialized step-ca configuration into /etc/step-ca
#  ansible.builtin.command: >
#    mv $(step path)/* /etc/step-ca
#  args:
#    removes: /etc/step
#  become: yes
#  ignore_errors: yes  # Safe in case it's already moved (e.g., image rebuild)
#
#- name: Ensure CA password file exists and is properly secured
#  ansible.builtin.copy:
#    dest: /etc/step-ca/password.txt
#    content: "{{ step_ca_password | default('change-me') }}"
#    owner: step
#    group: step
#    mode: '0600'
#
#- name: Update defaults.json to use /etc/step-ca path
#  ansible.builtin.command: >
#    jq '.path = "/etc/step-ca"' /etc/step-ca/config/defaults.json > /etc/step-ca/config/defaults.json.tmp
#  become: yes
#  args:
#    creates: /etc/step-ca/config/defaults.json.tmp
#
#- name: Replace updated defaults.json
#  ansible.builtin.command: >
#    mv /etc/step-ca/config/defaults.json.tmp /etc/step-ca/config/defaults.json
#  become: yes
#
#- name: Set ownership of /etc/step-ca recursively
#  ansible.builtin.file:
#    path: /etc/step-ca
#    state: directory
#    recurse: yes
#    owner: step
#    group: step
#    mode: '0750'
#
#- name: Update ca.json to point database to /etc/step-ca/db
#  ansible.builtin.command: >
#    bash -c 'cat <<< $(jq ".db.dataSource = \"/etc/step-ca/db\"" /etc/step-ca/config/ca.json) > /etc/step-ca/config/ca.json'
#  become: yes
#  args:
#    creates: /etc/step-ca/config/ca.json
#
#- name: Create systemd service for step-ca
#  copy:
#    dest: /etc/systemd/system/nautobot-scheduler.service
#    content: |
#      [Unit]
#      Description=step-ca service
#      Documentation=https://smallstep.com/docs/step-ca
#      Documentation=https://smallstep.com/docs/step-ca/certificate-authority-server-production
#      After=network-online.target
#      Wants=network-online.target
#      StartLimitIntervalSec=30
#      StartLimitBurst=3
#      ConditionFileNotEmpty=/etc/step-ca/config/ca.json
#      ConditionFileNotEmpty=/etc/step-ca/password.txt
#
#      [Service]
#      Type=simple
#      User=step
#      Group=step
#      Environment=STEPPATH=/etc/step-ca
#      WorkingDirectory=/etc/step-ca
#      ExecStart=/usr/bin/step-ca config/ca.json --password-file password.txt
#      ExecReload=/bin/kill --signal HUP $MAINPID
#      Restart=on-failure
#      RestartSec=5
#      TimeoutStopSec=30
#      StartLimitInterval=30
#      StartLimitBurst=3
#
#      ; Process capabilities & privileges
#      AmbientCapabilities=CAP_NET_BIND_SERVICE
#      CapabilityBoundingSet=CAP_NET_BIND_SERVICE
#      SecureBits=keep-caps
#      NoNewPrivileges=yes
#
#      ; Sandboxing
#      ProtectSystem=full
#      ProtectHome=true
#      RestrictNamespaces=true
#      RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
#      PrivateTmp=true
#      PrivateDevices=true
#      ProtectClock=true
#      ProtectControlGroups=true
#      ProtectKernelTunables=true
#      ProtectKernelLogs=true
#      ProtectKernelModules=true
#      LockPersonality=true
#      RestrictSUIDSGID=true
#      RemoveIPC=true
#      RestrictRealtime=true
#      SystemCallFilter=@system-service
#      SystemCallArchitectures=native
#      MemoryDenyWriteExecute=true
#      ReadWriteDirectories=/etc/step-ca/db
#
#      [Install]
#      WantedBy=multi-user.target
#  notify: Reload systemd
#
#- name: Enable step-ca service to start on boot
#  ansible.builtin.systemd_service:
#    name: step-ca
#    enabled: yes
#    state: stopped