---
- name: Ensure /var/db/tang directory exists
  file:
    path: /var/db/tang
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Clevis systemd config
  copy:
    dest: /etc/systemd/system/clevis-bind-usb.service
    content: |
      [Unit]
      Description=Bind Clevis Tang keyslot to encrypted USB
      After=network-online.target tangd.socket
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/clevis_bind_usb.sh
      User=root

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Create Clevis bind script (UUID -> UUID)
  copy:
    dest: /usr/local/bin/clevis_bind_usb.sh
    mode: '0750'
    content: |
      #!/bin/bash
      set -euo pipefail

      UNENCRYPTED_UUID=$(blkid -o value -s UUID -t LABEL="{{ unencrypted_usb_label }}" 2>/dev/null)
      if [ -z "$UNENCRYPTED_UUID" ]; then
        echo "No device found with label"
        exit 1
      fi

      #############################################
      # Device UUIDs (injected by Ansible)
      #############################################
      LUKS_UUID="{{ encrypted_luks_uuid }}"
      PASSWORD_FILE="luks_passphrase.txt"
      TANG_URL="http://127.0.0.1"

      #############################################
      # Resolve block devices from UUIDs
      #############################################
      UNENCRYPTED_DEV="/dev/disk/by-uuid/${UNENCRYPTED_UUID}"
      LUKS_DEV="/dev/disk/by-uuid/${LUKS_UUID}"

      if [[ ! -b "$UNENCRYPTED_DEV" ]]; then
          echo "ERROR: Unencrypted USB device not found: $UNENCRYPTED_DEV"
          exit 1
      fi

      if [[ ! -b "$LUKS_DEV" ]]; then
          echo "ERROR: LUKS device not found: $LUKS_DEV"
          exit 1
      fi

      #############################################
      # Create a temporary mount location
      #############################################
      TMPDIR="$(mktemp -d /run/unencrypted_usb.XXXXXX)"

      cleanup() {
          umount "$TMPDIR" || true
          rm -rf "$TMPDIR"
      }
      trap cleanup EXIT

      echo "Mounting unencrypted USB..."
      mount "$UNENCRYPTED_DEV" "$TMPDIR"

      #############################################
      # Read password
      #############################################
      PASS_PATH="${TMPDIR}/${PASSWORD_FILE}"

      if [[ ! -f "$PASS_PATH" ]]; then
          echo "ERROR: Password file not found: $PASS_PATH"
          exit 1
      fi

      LUKS_PASS="$(cat "$PASS_PATH")"

      if [[ -z "$LUKS_PASS" ]]; then
          echo "ERROR: Password file is empty!"
          exit 1
      fi

      #############################################
      # Skip if Clevis already bound
      #############################################
      if cryptsetup luksDump "$LUKS_DEV" | grep -qi "clevis"; then
          echo "Clevis keyslot already exists â€” skipping."
          exit 0
      fi

      echo "Initializing Tang keys..."
      /usr/libexec/tangd-keygen /var/db/tang

      #############################################
      # Bind Clevis/Tang keyslot
      #############################################
      echo "Binding Clevis Tang keyslot..."
      clevis luks bind -k "$PASS_PATH" -d "$LUKS_DEV" tang "{\"url\":\"$TANG_URL\"}" -y

      sudo cryptsetup luksDump "$LUKS_DEV" \
        | grep -A5 -i "Keyslot" \
        | sudo tee /boot/luks_keyslots.txt > /dev/null


      echo "Clevis bind complete."
      exit 0
  notify: Reload systemd

- name: Add crypttab entry for Tang auto-unlock
  lineinfile:
    path: /etc/crypttab
    line: "intermediateca UUID={{ encrypted_luks_uuid }} none luks,_netdev,clevis:tang=http://127.0.0.1"
    create: yes

- name: Rebuild initramfs
  command: update-initramfs -u -k 'all'
