### GOALS ###
# Use a strong keyfile enrolled into the encrypted USB (storing an intermediate CA)
# Stored on the host filesystem (rootfs) and not on the removable USB
# Remove the unencrypted USB after enrollment

### Reasoning ###
# No TPM hardware needed
# Auto-unlock encrypted USB at boot (via crypttab + keyfile)
# Unencrypted USB can be removed/wiped after setup
# Recovery password preserved for future disasters (stored in Slot 0 or a secure vault)
# No Tang/Clevis network dependency
# Industry common pattern (keyfile enrollment for removable volumes, vault/airgap for recovery secret)

---
- name: Ensure /var/lib/clevis directory exists
  file:
    path: /var/lib/clevis
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure /var/db/tang directory exists
  file:
    path: /var/db/tang
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Clevis bind script (UUID -> UUID)
  copy:
    dest: /usr/local/bin/clevis_bind_usb.sh
    mode: '0750'
    content: |
      #!/bin/bash
      set -euo pipefail

      UNENCRYPTED_UUID=$(blkid -o value -s UUID -t LABEL="{{ unencrypted_usb_label }}" 2>/dev/null)
      if [ -z "$UNENCRYPTED_UUID" ]; then
        echo "No device found with label"
        exit 1
      fi

      #############################################
      # Device UUIDs (injected by Ansible)
      #############################################
      LUKS_UUID="{{ encrypted_luks_uuid }}"
      PASSWORD_FILE="luks_passphrase.txt"
      TANG_URL="http://127.0.0.1"

      #############################################
      # Resolve block devices from UUIDs
      #############################################
      UNENCRYPTED_DEV="/dev/disk/by-uuid/${UNENCRYPTED_UUID}"
      LUKS_DEV="/dev/disk/by-uuid/${LUKS_UUID}"

      if [[ ! -b "$UNENCRYPTED_DEV" ]]; then
          echo "ERROR: Unencrypted USB device not found: $UNENCRYPTED_DEV"
          exit 1
      fi

      if [[ ! -b "$LUKS_DEV" ]]; then
          echo "ERROR: LUKS device not found: $LUKS_DEV"
          exit 1
      fi

      #############################################
      # Create a temporary mount location
      #############################################
      TMPDIR="$(mktemp -d /run/unencrypted_usb.XXXXXX)"

      cleanup() {
          umount "$TMPDIR" || true
          rm -rf "$TMPDIR"
      }
      trap cleanup EXIT

      echo "Mounting unencrypted USB..."
      mount "$UNENCRYPTED_DEV" "$TMPDIR"

      #############################################
      # Read password
      #############################################
      PASS_PATH="${TMPDIR}/${PASSWORD_FILE}"

      if [[ ! -f "$PASS_PATH" ]]; then
          echo "ERROR: Password file not found: $PASS_PATH"
          exit 1
      fi

      LUKS_PASS="$(cat "$PASS_PATH")"

      if [[ -z "$LUKS_PASS" ]]; then
          echo "ERROR: Password file is empty!"
          exit 1
      fi

      #############################################
      # Skip if Clevis already bound
      #############################################
      if cryptsetup luksDump "$LUKS_DEV" | grep -qi "clevis"; then
          echo "Clevis keyslot already exists â€” skipping."
          echo "Attempting to create marker file: /var/lib/clevis/clevis-enrolled-$LUKS_UUID"
          touch /var/lib/clevis/clevis-enrolled-$LUKS_UUID || { echo "Failed to create marker file"; exit 1; }
          exit 0
      fi

      echo "Initializing Tang keys..."
      /usr/libexec/tangd-keygen /var/db/tang

      #############################################
      # Bind Clevis/Tang keyslot
      #############################################
      echo "Binding Clevis Tang keyslot..."
      clevis luks bind -k "$PASS_PATH" -d "$LUKS_DEV" tang "{\"url\":\"$TANG_URL\"}" -y

      echo "Attempting to create marker file: /var/lib/clevis/clevis-enrolled-$LUKS_UUID"
      touch /var/lib/clevis/clevis-enrolled-$LUKS_UUID || { echo "Failed to create marker file"; exit 1; }


      echo "Clevis bind complete."
      exit 0

- name: Install systemd unit to enroll Clevis on USB when device appears (first boot only)
  copy:
    dest: /etc/systemd/system/clevis-bind-usb.service
    content: |
      [Unit]
      Description=Enroll Clevis Tang for LUKS USB
      After=network-online.target tangd.socket
      Wants=network-online.target
      ConditionPathExists=!/var/lib/clevis/clevis-enrolled-{{ encrypted_luks_uuid }}

      [Service]
      Type=oneshot
      User=root
      Group=root
      ExecStart=/usr/local/bin/clevis_bind_usb.sh
      StandardOutput=journal
      StandardError=journal
      Restart=no

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Ensure systemd services are enabled but not running
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: true
    state: stopped
  loop:
    - clevis-bind-usb.service
    - tangd.socket
    - tangd@80.service

#- name: Add crypttab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/crypttab
#    line: "intermediateca UUID={{ encrypted_luks_uuid }} none luks" # _netdev?
#    create: yes

#- name: Add fstab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/fstab
#    line: "/dev/mapper/intermediateca /mnt/intermediateca ext4 defaults,_netdev 0 2"
#    create: yes

#- name: Create real unlock service for future boots (no password prompt)
#  copy:
#    dest: /etc/systemd/system/tangd@80.service
#    content: |
#      [Unit]
#      Description=Auto unlock LUKS USB via Clevis Tang
#      Requires=network-online.target tangd.socket
#      After=network-online.target tangd.socket
#      ConditionPathExists=/etc/clevis-enrolled-{{ encrypted_luks_uuid }}
#
#      [Service]
#      Type=oneshot
#      RemainAfterExit=yes
#      ExecStart=/bin/bash -c "clevis luks unlock -d /dev/disk/by-uuid/{{ encrypted_luks_uuid }} -n intermediateca"
#      ExecStop=/sbin/cryptsetup close intermediateca
#
#      [Install]
#      WantedBy=multi-user.target
#  notify: Reload systemd

#- name: Create marker file so enrollment runs only once
#  copy:
#    dest: /etc/clevis-enrolled-{{ encrypted_luks_uuid }}
#    content: "Clevis enrolled"
#    owner: root
#    group: root
#    mode: '0644'

#- name: Ensure dracut directory exists
#  file:
#    path: /etc/dracut.conf.d
#    state: directory
#    owner: root
#    group: root
#    mode: '0755'
#
#- name: Create Dracut Clevis Conf File
#  copy:
#    dest: /etc/dracut.conf.d/clevis.conf
#    content: "hostonly_cmdline=yes"
#    owner: root
#    group: root
#    mode: '0644'



#- name: Create Clevis systemd config
#  copy:
#    dest: /etc/systemd/system/clevis-bind-usb.service
#    content: |
#      [Unit]
#      Description=Bind Clevis Tang keyslot to encrypted USB
#      After=network-online.target tangd.socket
#      Wants=network-online.target
#
#      [Service]
#      Type=oneshot
#      ExecStart=/usr/local/bin/clevis_bind_usb.sh
#      User=root
#
#      [Install]
#      WantedBy=multi-user.target
#  notify: Reload systemd


#- name: Add crypttab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/crypttab
#    line: "intermediateca UUID={{ encrypted_luks_uuid }} none luks"
#    create: yes


#- name: Create a systemd service to unlock it at boot
#  copy:
#    dest: /etc/systemd/system/crypt-intermediateca-tang.service
#    content: |
#      [Unit]
#      Description=Auto unlock LUKS USB using Clevis Tang
#      Requires=network-online.target
#      After=network-online.target
#
#      [Service]
#      Type=oneshot
#      RemainAfterExit=yes
#      ExecStart=clevis luks unlock -d /dev/disk/by-uuid/{{ encrypted_luks_uuid }} --pin tang {"url":"http://127.0.0.1"}
#      ExecStop=/sbin/cryptsetup close intermediateca
#
#      [Install]
#      WantedBy=remote-cryptsetup.target
#
#  notify: Reload systemd


#- name: Rebuild initramfs
#  command: update-initramfs -u -k 'all'


#- name: Rebuild initramfs (important for network + clevis/tang pins to be present at boot)
#  command: update-initramfs -u -k all
#  changed_when: true