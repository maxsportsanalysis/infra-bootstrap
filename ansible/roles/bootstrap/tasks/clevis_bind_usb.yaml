---
# 1 — Wait for LUKS device to exist (important for Packer builds)
- name: Wait for LUKS device to appear (Packer may not attach instantly)
  ansible.builtin.wait_for:
    path: "{{ luks_device }}"
    state: present
    timeout: 30

# 2 — Generate a static keyfile if not present (only used for initial bind)
- name: Ensure initial LUKS keyfile exists
  ansible.builtin.command: "dd if=/dev/urandom of={{ luks_keyfile_path }} bs=32 count=1"
  args:
    creates: "{{ luks_keyfile_path }}"

# 3 — Set keyfile permissions
- name: Set keyfile permissions
  ansible.builtin.file:
    path: "{{ luks_keyfile_path }}"
    owner: root
    group: root
    mode: '0400'

# 4 — Apply persistent LUKS label so systemd opens it under the correct /dev/mapper name
- name: Set persistent LUKS label
  ansible.builtin.command: "cryptsetup config {{ luks_device }} --label intermediateca"
  register: label_set
  changed_when: label_set.rc == 0

# 5 — Verify label is present
- name: Read back LUKS metadata
  ansible.builtin.command: "cryptsetup luksDump {{ luks_device }}"
  register: luksdump
  changed_when: false

- name: Fail if label was not applied
  ansible.builtin.fail:
    msg: "LUKS label 'intermediateca' was not set!"
  when: "'Label: intermediateca' not in luksdump.stdout"

# 6 — Check if Clevis is already bound
- name: Check if Clevis keyslot is already bound
  ansible.builtin.command: "cryptsetup luksDump {{ luks_device }}"
  register: clevis_check
  changed_when: false

# 7 — Bind Clevis/Tang to a new keyslot if not already present
- name: Bind Clevis Tang keyslot
  ansible.builtin.command: >
    clevis luks bind -d {{ luks_device }} tang '{"url":"http://127.0.0.1"}' -y
  when: "'clevis' not in clevis_check.stdout.lower()"
  register: clevis_bind
  changed_when: clevis_bind.rc == 0

# 8 — Persist in crypttab so systemd-cryptsetup attach opens it using that label
- name: Add LUKS USB to crypttab by UUID
  ansible.builtin.lineinfile:
    path: "{{ crypttab_path }}"
    line: "intermediateca {{ encrypted_luks_uuid }} none luks,_netdev"
    create: yes

# 9 — Create systemd unit to unlock at boot using Tang via Clevis
- name: Create systemd auto-unlock service
  ansible.builtin.copy:
    dest: "/etc/systemd/system/crypt-intermediateca-tang.service"
    content: |
      [Unit]
      Description=Auto unlock LUKS USB using Clevis Tang
      Requires=network-online.target
      After=network-online.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/bin/clevis luks unlock -d {{ luks_device }} --pin tang '{"url":"http://127.0.0.1"}'
      ExecStop=/usr/bin/cryptsetup close intermediateca

      [Install]
      WantedBy=remote-cryptsetup.target
  notify: Reload systemd

# 10 — Enable required boot units correctly
- name: Enable Tang socket (required)
  ansible.builtin.systemd_service:
    name: tangd.socket
    enabled: true
    state: started

- name: Enable LUKS auto-unlock service (required)
  ansible.builtin.systemd_service:
    name: crypt-intermediateca-tang.service
    enabled: true
    state: stopped

# 11 — Rebuild initramfs to safely embed keyslot metadata (optional but good)
- name: Rebuild initramfs
  ansible.builtin.command: "update-initramfs -u -k all"
  changed_when: true

# 12 — Reboot to apply
- name: Reboot to apply LUKS auto-unlock
  ansible.builtin.reboot:

# 13 — Validate after boot
- name: Confirm mapper exists
  ansible.builtin.command: "lsblk"
  register: lsblk_out
  changed_when: false

- name: Fail if USB did not auto-unlock
  ansible.builtin.fail:
    msg: "/dev/mapper/intermediateca was not created — auto unlock failed!"
  when: "'intermediateca' not in lsblk_out.stdout.lower()"
