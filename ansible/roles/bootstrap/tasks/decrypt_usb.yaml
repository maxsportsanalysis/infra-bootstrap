### GOALS ###
# Use a strong keyfile enrolled into the encrypted USB (storing an intermediate CA)
# Stored on the host filesystem (rootfs) and not on the removable USB
# Remove the unencrypted USB after enrollment

### Reasoning ###
# No TPM hardware needed
# Auto-unlock encrypted USB at boot (via crypttab + keyfile)
# Unencrypted USB can be removed/wiped after setup
# Recovery password preserved for future disasters (stored in Slot 0 or a secure vault)
# No Tang/Clevis network dependency
# Industry common pattern (keyfile enrollment for removable volumes, vault/airgap for recovery secret)

---
- name: Ensure {{ clevis_marker_dir }} directory exists
  ansible.builtin.file:
    path: "{{ clevis_marker_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure {{ tang_key_dir }} directory exists
  ansible.builtin.file:
    path: "{{ tang_key_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Clevis bind script (UUID -> UUID)
  ansible.builtin.copy:
    dest: /usr/local/bin/clevis_bind_usb.sh
    mode: '0750'
    content: |
      #!/bin/bash
      set -o nounset # Disallow expansion of unset variables
      
      readonly tangd_keygen_path='/usr/libexec/tangd-keygen'
      
      error() { 
        echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*" >&2 
      }
      
      #######################################
      # Check if a block device is found.
      # Arguments:
      #   Block device path.
      # Returns:
      #   0 if block device exists; non-zero otherwise.
      #######################################
      device_check() {
        local device_path="$1"
        if [[ ! -b "${device_path}" ]]; then
          return 1
        fi
        return 0
      }
      
      #######################################
      # Clevis unlock block device.
      # Arguments:
      #   Block device path.
      # Returns:
      #   0 if device unlocked, non-zero on error.
      #######################################
      clevis_unlock_usb() {
        local device_path="$1"
        if clevis luks unlock -d "${device_path}" >/dev/null 2>&1; then
          return 0
        fi
      }
      
      #######################################
      # Remove keyslots from block device created by clevis.
      # Arguments:
      #   Block device path.
      # Returns:
      #   0 if keyslot(s) removed, non-zero on error.
      #######################################
      remove_keyslots() {
        local device_path="$1"
        local keyslots
        readarray -t keyslots < <(cryptsetup luksDump "${device_path}" | awk '/clevis/ {print $2}')
        if [ "${#keyslots[@]}" -gt 0 ]; then
          for slot in $(keyslots); do
            if ! cryptsetup --batch-mode luksKillSlot "${device_path}" "$slot"; then
              return 1
            fi
          done
        return 0
      }
      
      main() {
        echo "Setting up Tang and Clevis for automated unlocking of removable storage devices."
        
        local encrypted_usb="$1"
        if device_check $encrypted_usb; then
          echo "Block device successfully found: $encrypted_usb"
        else
          error "Block device not found: $encrypted_usb"
          exit 1
        fi
      
        local encrypted_usb_name="$(basename "${encrypted_usb}")"
        if clevis luks unlock -d "${encrypted_usb}"; then
          echo "Encrypted usb is unlocked: ${encrypted_usb_name}"
          exit 0
        fi
        echo "Could not unlock encrypted usb: ${encrypted_usb_name}"
      
        if remove_keyslots $encrypted_usb; then
          echo "Keyslots successfully removed from ${encrypted_usb_name}"
        else
          error "Failed to remove clevis keyslots: ${encrypted_usb_name}"
          exit 1
        fi
      
        local key_usb="$2"
        if device_check $key_usb; then
          log "Block device successfully found: $key_usb"
        else
          error "Block device not found: $key_usb"
          exit 1
        fi
      
        local key_usb_mount="$3"
        if [[ ! -d "${key_usb_mount}" ]]; then
          key_usb_mount=$(mktemp -d "${key_usb_mount}")
        fi

        local keyfile_name="$4"
        local keyfile_path="${key_usb_mount}/${keyfile_name}"
        if ! mountpoint -q "${key_usb_mount}"; then
          if ! mount "${key_usb}" "${key_usb_mount}"; then
            error "Failed to create key_usb_mount directory: ${encrypted_usb_name}"
            exit 1
          else
            if [[ ! -s "${keyfile_path}" ]]; then
              error "Keyfile does not exist or is empty: ${keyfile_path}"
              exit 1
            fi
          fi
        fi
        echo "Keyfile found and mounted: ${keyfile_path}"
      
        local tang_key_dir="$5"
        if [[ ! -d "${tang_key_dir}" ]]; then
          mkdir -p "${tang_key_dir}"
        fi
      
        if [[ -z "$(ls -A "${tang_key_dir}")" ]]; then
          echo "Tang keys not initialized"
          "${tangd_keygen_path}" "${tang_key_dir}"
          echo "Initialized tang keys and put them in ${tang_key_dir}"
        else
          echo "Tang keys already initialized"
        fi
      
        local tang_server="$6"
        echo "Binding Clevis and Tang keyslot to block device: ${encrypted_usb_name}"
        if ! clevis luks bind -k "${keyfile_path}" -d "${encrypted_usb}" tang "{\"url\":\"${tang_server}\"}" -y; then
          error "Failed to bind keyslot to block device: ${encrypted_usb_name}"
          exit 1
        fi
        echo "Successfully binded keyslot to block device: "$(cryptsetup luksDump -d "${encrypted_usb}")""

        local clevis_marker_dir="$7"
        if [[ ! -d "${clevis_marker_dir}" ]]; then
          mkdir -p "${clevis_marker_dir}"
        fi

        local clevis_marker_path="${clevis_marker_dir}/clevis-enrolled-${encrypted_usb_name}"
        touch "${clevis_marker_path}"
        echo "Created marker file for clevis: ${clevis_marker_path}"
      }

      main "$@"
            
- name: Get basename of encrypted_usb path
  ansible.builtin.set_fact:
    encrypted_usb_name: "{{ encrypted_usb | community.general.basename }}"

- name: Install systemd unit to enroll Clevis on USB when device appears (first boot only)
  ansible.builtin.copy:
    dest: /etc/systemd/system/clevis-bind-usb.service
    content: |
      [Unit]
      Description=Enroll Clevis Tang for LUKS USB
      After=network-online.target tangd.socket
      Wants=network-online.target
      ConditionPathExists=!{{ clevis_marker_dir }}/clevis-enrolled-{{ encrypted_usb_name }}

      [Service]
      Type=oneshot
      User=root
      Group=root
      ExecStart=/usr/local/bin/clevis_bind_usb.sh "{{ encrypted_usb }}" "{{ key_usb }}" "{{ key_usb_mount }}" "{{ keyfile_name }}" "{{ tang_key_dir }}" "{{ tang_server }}" "{{ clevis_marker_dir }}"
      StandardOutput=journal
      StandardError=journal
      Restart=no

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Ensure systemd services are enabled but not running
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: true
    state: stopped
  loop:
    - clevis-bind-usb.service
    - tangd.socket
    - tangd@80.service

#- name: Add crypttab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/crypttab
#    line: "intermediateca UUID={{ encrypted_luks_uuid }} none luks" # _netdev?
#    create: yes

#- name: Add fstab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/fstab
#    line: "/dev/mapper/intermediateca /mnt/intermediateca ext4 defaults,_netdev 0 2"
#    create: yes

#- name: Create real unlock service for future boots (no password prompt)
#  copy:
#    dest: /etc/systemd/system/tangd@80.service
#    content: |
#      [Unit]
#      Description=Auto unlock LUKS USB via Clevis Tang
#      Requires=network-online.target tangd.socket
#      After=network-online.target tangd.socket
#      ConditionPathExists=/etc/clevis-enrolled-{{ encrypted_luks_uuid }}
#
#      [Service]
#      Type=oneshot
#      RemainAfterExit=yes
#      ExecStart=/bin/bash -c "clevis luks unlock -d /dev/disk/by-uuid/{{ encrypted_luks_uuid }} -n intermediateca"
#      ExecStop=/sbin/cryptsetup close intermediateca
#
#      [Install]
#      WantedBy=multi-user.target
#  notify: Reload systemd

#- name: Create marker file so enrollment runs only once
#  copy:
#    dest: /etc/clevis-enrolled-{{ encrypted_luks_uuid }}
#    content: "Clevis enrolled"
#    owner: root
#    group: root
#    mode: '0644'

#- name: Ensure dracut directory exists
#  file:
#    path: /etc/dracut.conf.d
#    state: directory
#    owner: root
#    group: root
#    mode: '0755'
#
#- name: Create Dracut Clevis Conf File
#  copy:
#    dest: /etc/dracut.conf.d/clevis.conf
#    content: "hostonly_cmdline=yes"
#    owner: root
#    group: root
#    mode: '0644'



#- name: Create Clevis systemd config
#  copy:
#    dest: /etc/systemd/system/clevis-bind-usb.service
#    content: |
#      [Unit]
#      Description=Bind Clevis Tang keyslot to encrypted USB
#      After=network-online.target tangd.socket
#      Wants=network-online.target
#
#      [Service]
#      Type=oneshot
#      ExecStart=/usr/local/bin/clevis_bind_usb.sh
#      User=root
#
#      [Install]
#      WantedBy=multi-user.target
#  notify: Reload systemd


#- name: Add crypttab entry for Tang auto-unlock
#  lineinfile:
#    path: /etc/crypttab
#    line: "intermediateca UUID={{ encrypted_luks_uuid }} none luks"
#    create: yes


#- name: Create a systemd service to unlock it at boot
#  copy:
#    dest: /etc/systemd/system/crypt-intermediateca-tang.service
#    content: |
#      [Unit]
#      Description=Auto unlock LUKS USB using Clevis Tang
#      Requires=network-online.target
#      After=network-online.target
#
#      [Service]
#      Type=oneshot
#      RemainAfterExit=yes
#      ExecStart=clevis luks unlock -d /dev/disk/by-uuid/{{ encrypted_luks_uuid }} --pin tang {"url":"http://127.0.0.1"}
#      ExecStop=/sbin/cryptsetup close intermediateca
#
#      [Install]
#      WantedBy=remote-cryptsetup.target
#
#  notify: Reload systemd


#- name: Rebuild initramfs
#  command: update-initramfs -u -k 'all'


#- name: Rebuild initramfs (important for network + clevis/tang pins to be present at boot)
#  command: update-initramfs -u -k all
#  changed_when: true