---
#- name: Write LUKS keyfile from secret
#  copy:
#    content: "{{ luks_keyfile_content }}"
#    dest: /root/luks_keyfile
#    owner: root
#    group: root
#    mode: '0600'
#  when: luks_keyfile_content is defined
#  no_log: true   # hides keyfile content in logs for security
#
#- name: Configure crypttab to use keyfile
#  lineinfile:
#    path: /etc/crypttab
#    regexp: '^intermediate_ca'
#    line: "intermediate_ca UUID=0c0c73a8-79f9-4554-b241-27636c5d6a9d /root/luks_keyfile luks"
#    create: yes
#    backrefs: no
#  when: luks_keyfile_content is defined
#  notify: Reload systemd  # so changes take effect on reboot

- name: Write LUKS keyfile from secret
  copy:
    content: "{{ luks_keyfile_content }}"
    dest: /root/luks_keyfile
    owner: root
    group: root
    mode: '0600'
  when: luks_keyfile_content is defined

- name: Configure crypttab to use keyfile
  lineinfile:
    path: /etc/crypttab
    regexp: '^intermediate_ca'
    line: "intermediate_ca UUID=0c0c73a8-79f9-4554-b241-27636c5d6a9d /root/luks_keyfile luks"
    create: yes
  when: luks_keyfile_content is defined

- name: Ensure /mnt/intermediate_ca directory exists and owned by root
  file:
    path: /mnt/intermediate_ca
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Add fstab entry for intermediate_ca mount
  lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/intermediate_ca'
    line: "/dev/mapper/intermediate_ca /mnt/intermediate_ca ext4 defaults,noatime,nodiratime 0 2"
    create: yes