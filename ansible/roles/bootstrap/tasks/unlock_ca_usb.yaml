---
- name: Write LUKS keyfile from secret
  copy:
    content: "{{ luks_keyfile_content }}"
    dest: /root/luks_keyfile
    owner: root
    group: root
    mode: '0600'
  when: luks_keyfile_content is defined

- name: Configure crypttab to use keyfile
  lineinfile:
    path: /etc/crypttab
    regexp: '^intermediate_ca'
    line: "intermediate_ca UUID=0c0c73a8-79f9-4554-b241-27636c5d6a9d /root/luks_keyfile luks"
    create: yes
  when: luks_keyfile_content is defined
